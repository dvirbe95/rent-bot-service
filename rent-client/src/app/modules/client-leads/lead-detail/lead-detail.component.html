<div class="container" *ngIf="!loading">
  <!-- Back Button for Mobile -->
  <button mat-button routerLink="/client-leads" class="back-btn">
    <mat-icon>chevron_right</mat-icon> חזרה לרשימה
  </button>

  <mat-card class="lead-info-card">
    <mat-card-header>
      <mat-card-title>{{lead.tenantName || 'לקוח אנונימי'}}</mat-card-title>
      <mat-card-subtitle>{{lead.apartment?.city}}, {{lead.apartment?.address}}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="info-chips">
        <span class="status-chip" [attr.data-status]="lead.status">{{getStatusLabel(lead.status)}}</span>
        <span class="phone-chip" *ngIf="lead.tenantPhone">
          <mat-icon>phone</mat-icon> {{lead.tenantPhone}}
        </span>
      </div>
      
      <div class="lead-actions-grid">
        <a mat-flat-button color="primary" [href]="'tel:' + lead.tenantPhone" *ngIf="lead.tenantPhone">
          <mat-icon>phone</mat-icon> התקשר
        </a>
        <button mat-flat-button color="accent" (click)="openWaze(lead.apartment?.address)" *ngIf="lead.apartment?.address">
          <mat-icon>directions_car</mat-icon> Waze
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="chat-wrapper">
    <div class="chat-header">
      <mat-icon>forum</mat-icon>
      <span>היסטוריית שיחה</span>
    </div>
    
    <div class="messages-list">
      <div *ngFor="let msg of messages" 
           [ngClass]="['message-row', msg.senderType === 'TENANT' ? 'incoming' : 'outgoing']">
        <div class="bubble">
          <div class="sender-name">{{msg.senderType === 'TENANT' ? (lead.tenantName || 'לקוח') : 'הבוט שלי'}}</div>
          <p class="content">{{msg.content}}</p>
          <div class="timestamp">{{msg.timestamp | date:'HH:mm'}}</div>
        </div>
      </div>
      
      <div class="empty-chat" *ngIf="messages.length === 0">
        <mat-icon>chat_bubble_outline</mat-icon>
        <p>טרם נשלחו הודעות בשיחה זו</p>
      </div>
    </div>

    <div class="chat-footer">
      <form [formGroup]="messageForm" (ngSubmit)="sendMessage()">
        <mat-form-field appearance="outline">
          <input matInput formControlName="content" placeholder="הקלד הודעה ללקוח...">
          <button mat-icon-button matSuffix color="primary" type="submit" [disabled]="messageForm.invalid">
            <mat-icon>send</mat-icon>
          </button>
        </mat-form-field>
      </form>
    </div>
  </div>
</div>

<div class="loading-overlay" *ngIf="loading">
  <mat-spinner diameter="50"></mat-spinner>
</div>
