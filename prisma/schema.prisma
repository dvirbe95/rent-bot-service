// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  chatId          String?  @unique // Telegram Chat ID
  name            String?
  phone           String?  @unique // מזהה ייחודי לבוט ולמשתמשים
  email           String?  @unique
  password        String?  // לאפליקציה (מתווכים)
  role            UserRole @default(USER)
  
  apartments      Apartment[]
  posts           Post[]   
  
  metadata        Json?    
  current_step    String?  @default("START") // לשימוש הבוט
  subscriptionStatus Boolean @default(false)
  planExpiresAt   DateTime?
  
  lastLogin       DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("users")
}

model Apartment {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  city            String
  price           Float
  rooms           Float
  description     String?
  address         String?
  availability    Json?    
  images          String[]
  video_url       String?
  
  embeddings      Float[]  
  
  clientLeads     ClientLead[]
  posts           Post[]   
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("apartments")
}

model ClientLead {
  id              String   @id @default(uuid())
  apartmentId     String
  apartment       Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)
  
  tenantChatId    String   
  tenantName      String?
  tenantPhone     String?
  tenantEmail     String?
  
  status          LeadStatus @default(NEW)
  lastMessageAt   DateTime @default(now())
  messages        LeadMessage[]
  meetings        Meeting[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([apartmentId])
  @@index([tenantChatId])
  @@map("client_leads")
}

model LeadMessage {
  id          String   @id @default(uuid())
  leadId      String
  lead        ClientLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  senderType  SenderType 
  content     String
  timestamp   DateTime @default(now())
  
  @@index([leadId])
  @@map("lead_messages")
}

model Meeting {
  id          String   @id @default(uuid())
  leadId      String
  lead        ClientLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  startTime   DateTime
  endTime     DateTime
  location    String?
  status      MeetingStatus @default(SCHEDULED)
  
  createdAt   DateTime @default(now())
  
  @@index([leadId])
  @@map("meetings")
}

model Post {
  id              String   @id @default(uuid())
  apartmentId     String
  apartment       Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  content         String   
  platform        PostPlatform
  publishedAt     DateTime? 
  
  createdAt       DateTime @default(now())
  
  @@index([apartmentId])
  @@index([userId])
  @@map("posts")
}

enum UserRole {
  USER
  AGENT
  ADMIN
  TENANT
  LANDLORD
  SELLER
}

enum LeadStatus {
  NEW
  INTERESTED
  VIEWING_SCHEDULED
  DEAL_CLOSED
  LOST
}

enum SenderType {
  TENANT
  BOT
  AGENT
}

enum PostPlatform {
  TELEGRAM
  FACEBOOK
  WHATSAPP
  INSTAGRAM
}

enum MeetingStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}
