// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  chatId          String?  @unique
  name            String?
  phone           String?  @unique
  email           String?  @unique
  password        String?
  role            UserRole @default(USER)
  apartments      Apartment[]
  posts           Post[]
  notifications   Notification[]
  metadata        Json?
  current_step    String?  @default("START")
  subscriptionStatus Boolean @default(false)
  planExpiresAt   DateTime?
  lastLogin       DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("users")
}

model Apartment {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  // פרטי בסיס
  city            String
  address         String?
  price           Float
  rooms           Float
  floor           Int?
  sqm             Int?
  
  // פרטים פיננסיים ל-AI
  arnona          Float?
  vaadBayit       Float?
  collateral      String?  // ערבונות
  priceFlexibility Boolean @default(false)
  
  // מאפייני נכס
  description     String?
  entryDate       DateTime?
  balcony         Boolean @default(false)
  shelter         Boolean @default(false) // מקלט
  mamad           Boolean @default(false) // ממ"ד
  furnished       Boolean @default(false)
  petsAllowed     Boolean @default(true)
  parking         Boolean @default(false)
  elevator        Boolean @default(false)
  
  // סביבה (ל-AI)
  nearbyConstruction Boolean @default(false)
  neighbors       String?
  commercialCenter String?
  schools         String?
  entertainmentAreas String?
  
  // יצירת קשר וניהול
  contactPhone    String?
  availability    Json?    // מערך של טווחי זמנים לביקורים
  
  // מדיה ומסמכים
  images          String[]
  video_url       String?
  documents       String[] // לינקים למסמכים (חוזה, טיוטה וכו')
  
  // נתוני מיקום והעשרה ממשלתית
  lat             Float?
  lng             Float?
  neighborhoodData Json?    // מידע על תחבורה, חינוך וכו' מ-data.gov.il
  
  embeddings      Float[]
  clientLeads     ClientLead[]
  posts           Post[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("apartments")
}

model ClientLead {
  id              String   @id @default(uuid())
  apartmentId     String
  apartment       Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)
  tenantChatId    String
  tenantName      String?
  tenantPhone     String?
  tenantEmail     String?
  status          LeadStatus @default(NEW)
  lastMessageAt   DateTime @default(now())
  messages        LeadMessage[]
  meetings        Meeting[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([apartmentId])
  @@index([tenantChatId])
  @@map("client_leads")
}

model LeadMessage {
  id          String   @id @default(uuid())
  leadId      String
  lead        ClientLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  senderType  SenderType
  content     String
  timestamp   DateTime @default(now())
  @@index([leadId])
  @@map("lead_messages")
}

model Meeting {
  id          String   @id @default(uuid())
  leadId      String
  lead        ClientLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  startTime   DateTime
  endTime     DateTime
  location    String?
  status      MeetingStatus @default(SCHEDULED)
  createdAt   DateTime @default(now())
  @@index([leadId])
  @@map("meetings")
}

model Post {
  id              String   @id @default(uuid())
  apartmentId     String
  apartment       Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  content         String
  platform        PostPlatform
  publishedAt     DateTime?
  createdAt       DateTime @default(now())
  @@index([apartmentId])
  @@index([userId])
  @@map("posts")
}

model Notification {
  id        String             @id @default(uuid())
  userId    String
  user      User               @relation(fields: [userId], references: [id])
  type      NotificationType
  title     String
  message   String
  status    NotificationStatus @default(PENDING)
  isRead    Boolean            @default(false)
  payload   Json?
  attempts  Int                @default(0)
  error     String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([status, createdAt])
  @@index([userId, isRead])
  @@map("notifications")
}

enum UserRole {
  USER
  AGENT
  ADMIN
  TENANT
  LANDLORD
  SELLER
}

enum LeadStatus {
  NEW
  INTERESTED
  VIEWING_SCHEDULED
  DEAL_CLOSED
  LOST
}

enum SenderType {
  TENANT
  BOT
  AGENT
}

enum PostPlatform {
  TELEGRAM
  FACEBOOK
  WHATSAPP
  INSTAGRAM
}

enum MeetingStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum NotificationType {
  NEW_LEAD
  NEW_MEETING
  NEW_MESSAGE
  SYSTEM_ALERT
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}
